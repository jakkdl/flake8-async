---
+++
@@ -24,7 +24,9 @@


 async def foo_yield_2():
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("function definition", lineno-1)
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("yield", lineno-1)
     await foo()

@@ -32,22 +34,29 @@
 async def foo_yield_3():  # error: 0, "exit", Statement("yield", lineno+2)
     await foo()
     yield
+    await trio.lowlevel.checkpoint()


 async def foo_yield_4():  # error: 0, "exit", Statement("yield", lineno+3)
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("function definition", lineno-1)
+    await trio.lowlevel.checkpoint()
     await (yield)  # error: 11, "yield", Statement("yield", lineno-1)
     yield  # safe
+    await trio.lowlevel.checkpoint()


 async def foo_yield_return_1():
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("function definition", lineno-1)
+    await trio.lowlevel.checkpoint()
     return  # error: 4, "return", Statement("yield", lineno-1)


 async def foo_yield_return_2():
     await foo()
     yield
+    await trio.lowlevel.checkpoint()
     return  # error: 4, "return", Statement("yield", lineno-1)


@@ -68,6 +77,7 @@
 async def foo_async_with_3():
     async with trio.fail_after(5):
         yield
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno-1)


@@ -77,6 +87,7 @@
         yield  # safe
     else:
         yield  # safe
+    await trio.lowlevel.checkpoint()


 # await anext(iter) is not called on break
@@ -85,6 +96,7 @@
         yield
         if ...:
             break
+    await trio.lowlevel.checkpoint()


 async def foo_async_for_3():  # safe
@@ -102,13 +114,16 @@
 async def foo_for():  # error: 0, "exit", Statement("yield", lineno+3)
     await foo()
     for i in "":
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno)
+    await trio.lowlevel.checkpoint()


 async def foo_for_1():  # error: 0, "exit", Statement("function definition", lineno) # error: 0, "exit", Statement("yield", lineno+3)
     for _ in "":
         await foo()
         yield
+    await trio.lowlevel.checkpoint()


 # while
@@ -121,13 +136,16 @@
     else:
         await foo()  # will always run
     yield  # safe
+    await trio.lowlevel.checkpoint()


 # simple yield-in-loop case
 async def foo_while_2():  # error: 0, "exit", Statement("yield", lineno+3)
     await foo()
     while foo():
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno)
+    await trio.lowlevel.checkpoint()


 # no checkpoint after yield if else is entered
@@ -136,39 +154,52 @@
         await foo()
         yield
     else:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno-2) # error: 8, "yield", Statement("function definition", lineno-5)
+    await trio.lowlevel.checkpoint()


 # check that errors are suppressed in visit_While
 async def foo_while_4():  # error: 0, "exit", Statement("yield", lineno+3) # error: 0, "exit", Statement("yield", lineno+5) # error: 0, "exit", Statement("yield", lineno+7)
     await foo()
     while foo():
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno) # error: 8, "yield", Statement("yield", lineno+2) # error: 8, "yield", Statement("yield", lineno+4)
         while foo():
+            await trio.lowlevel.checkpoint()
             yield  # error: 12, "yield", Statement("yield", lineno)# error: 12, "yield", Statement("yield", lineno-2)# error: 12, "yield", Statement("yield", lineno+2)
             while foo():
+                await trio.lowlevel.checkpoint()
                 yield  # error: 16, "yield", Statement("yield", lineno-2)# error: 16, "yield", Statement("yield", lineno)
+    await trio.lowlevel.checkpoint()


 # check that state management is handled in for loops as well
 async def foo_while_4_for():  # error: 0, "exit", Statement("yield", lineno+3) # error: 0, "exit", Statement("yield", lineno+5) # error: 0, "exit", Statement("yield", lineno+7)
     await foo()
     for i in bar():
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno) # error: 8, "yield", Statement("yield", lineno+2) # error: 8, "yield", Statement("yield", lineno+4)
         for i in bar():
+            await trio.lowlevel.checkpoint()
             yield  # error: 12, "yield", Statement("yield", lineno)# error: 12, "yield", Statement("yield", lineno-2)# error: 12, "yield", Statement("yield", lineno+2)
             for i in bar():
+                await trio.lowlevel.checkpoint()
                 yield  # error: 16, "yield", Statement("yield", lineno-2)# error: 16, "yield", Statement("yield", lineno)
+    await trio.lowlevel.checkpoint()


 # check error suppression is reset
 async def foo_while_5():
     await foo()
     while foo():
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno)

         async def foo_nested_error():  # error: 8, "exit", Statement("yield", lineno+1)
+            await trio.lowlevel.checkpoint()
             yield  # error: 12, "yield", Statement("function definition", lineno-1)
+            await trio.lowlevel.checkpoint()

     await foo()

@@ -178,16 +209,19 @@
 async def foo_while_continue_1():  # error: 0, "exit", Statement("yield", lineno+3)
     await foo()
     while foo():
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno)
         if ...:
             continue
         await foo()
+    await trio.lowlevel.checkpoint()


 # multiple continues
 async def foo_while_continue_2():  # error: 0, "exit", Statement("yield", lineno+3)
     await foo()
     while foo():
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno)
         if foo():
             continue
@@ -197,6 +231,7 @@
         while foo():
             yield  # safe
             await foo()
+    await trio.lowlevel.checkpoint()


 # --- while + break ---
@@ -207,7 +242,9 @@
             break
     else:
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("function definition", lineno-6)
+    await trio.lowlevel.checkpoint()


 # no checkpoint on break
@@ -218,6 +255,7 @@
         if ...:
             break
         await foo()
+    await trio.lowlevel.checkpoint()


 # guaranteed if else and break
@@ -229,6 +267,7 @@
     else:
         await foo()  # runs if 0-iter
     yield  # safe
+    await trio.lowlevel.checkpoint()


 # break at non-guaranteed checkpoint
@@ -239,7 +278,9 @@
         await foo()  # might not run
     else:
         await foo()  # might not run
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("function definition", lineno-7)
+    await trio.lowlevel.checkpoint()


 # check break is reset on nested
@@ -255,7 +296,9 @@
             await foo()
         yield  # safe
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("yield", lineno-9)
+    await trio.lowlevel.checkpoint()


 # check multiple breaks
@@ -270,7 +313,9 @@
         await foo()
         if ...:
             break
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("yield", lineno-8)
+    await trio.lowlevel.checkpoint()


 async def foo_while_break_7():  # error: 0, "exit", Statement("function definition", lineno)# error: 0, "exit", Statement("yield", lineno+5)
@@ -280,6 +325,7 @@
             break
         yield
         break
+    await trio.lowlevel.checkpoint()


 async def foo_while_endless_1():
@@ -292,6 +338,7 @@
     while foo():
         await foo()
         yield
+    await trio.lowlevel.checkpoint()


 async def foo_while_endless_3():
@@ -313,9 +360,11 @@
 # try
 async def foo_try_1():  # error: 0, "exit", Statement("function definition", lineno) # error: 0, "exit", Statement("yield", lineno+2)
     try:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("function definition", lineno-2)
     except:
         pass
+    await trio.lowlevel.checkpoint()


 # no checkpoint after yield in ValueError
@@ -323,12 +372,14 @@
     try:
         await foo()
     except ValueError:
+        await trio.lowlevel.checkpoint()
         # try might not have checkpointed
         yield  # error: 8, "yield", Statement("function definition", lineno-5)
     except:
         await foo()
     else:
         pass
+    await trio.lowlevel.checkpoint()


 async def foo_try_3():  # error: 0, "exit", Statement("yield", lineno+6)
@@ -337,13 +388,16 @@
     except:
         await foo()
     else:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("function definition", lineno-6)
+    await trio.lowlevel.checkpoint()


 async def foo_try_4():  # safe
     try:
         ...
     except:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("function definition", lineno-4)
     finally:
         await foo()
@@ -353,6 +407,7 @@
     try:
         await foo()
     finally:
+        await trio.lowlevel.checkpoint()
         # try might crash before checkpoint
         yield  # error: 8, "yield", Statement("function definition", lineno-5)
         await foo()
@@ -363,7 +418,9 @@
         await foo()
     except ValueError:
         pass
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("function definition", lineno-5)
+    await trio.lowlevel.checkpoint()


 async def foo_try_7():  # error: 0, "exit", Statement("yield", lineno+17)
@@ -376,6 +433,7 @@
         yield
         await foo()
     except SyntaxError:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("yield", lineno-7)
         await foo()
     finally:
@@ -384,6 +442,7 @@
     # by any of the excepts, jumping straight to the finally.
     # Then the error will be propagated upwards
     yield  # safe
+    await trio.lowlevel.checkpoint()


 ## safe only if (try or else) and all except bodies either await or raise
@@ -399,6 +458,7 @@
         raise
     else:
         await foo()
+    await trio.lowlevel.checkpoint()


 # no checkpoint after yield in else
@@ -409,6 +469,7 @@
         await foo()
     else:
         yield
+    await trio.lowlevel.checkpoint()


 # bare except means we'll jump to finally after full execution of either try or the except
@@ -439,6 +500,7 @@
     except ValueError:
         await foo()
     finally:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("function definition", lineno-6)
         await foo()

@@ -447,6 +509,7 @@
     try:
         await foo()
     finally:
+        await trio.lowlevel.checkpoint()
         # try might crash before checkpoint
         yield  # error: 8, "yield", Statement("function definition", lineno-5)
         await foo()
@@ -455,9 +518,11 @@
 # if
 async def foo_if_1():
     if ...:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("function definition", lineno-2)
         await foo()
     else:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("function definition", lineno-5)
         await foo()

@@ -468,7 +533,9 @@
         ...
     else:
         yield
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("yield", lineno-1)
+    await trio.lowlevel.checkpoint()


 async def foo_if_3():  # error: 0, "exit", Statement("yield", lineno+6)
@@ -477,7 +544,9 @@
         yield
     else:
         ...
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("yield", lineno-3)
+    await trio.lowlevel.checkpoint()


 async def foo_if_4():  # error: 0, "exit", Statement("yield", lineno+7)
@@ -487,7 +556,9 @@
         await foo()
     else:
         ...
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("yield", lineno-5)
+    await trio.lowlevel.checkpoint()


 async def foo_if_5():  # error: 0, "exit", Statement("yield", lineno+8)
@@ -498,7 +569,9 @@
     else:
         yield
         ...
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("yield", lineno-2)
+    await trio.lowlevel.checkpoint()


 async def foo_if_6():  # error: 0, "exit", Statement("yield", lineno+8)
@@ -509,7 +582,9 @@
         yield
         await foo()
         ...
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Statement("yield", lineno-5)
+    await trio.lowlevel.checkpoint()


 async def foo_if_7():  # error: 0, "exit", Statement("function definition", lineno)
@@ -517,6 +592,7 @@
         await foo()
         yield
         await foo()
+    await trio.lowlevel.checkpoint()


 async def foo_if_8():  # error: 0, "exit", Statement("function definition", lineno)
@@ -526,21 +602,25 @@
         await foo()
         yield
         await foo()
+    await trio.lowlevel.checkpoint()


 # IfExp
 async def foo_ifexp_1():  # error: 0, "exit", Statement("yield", lineno+1) # error: 0, "exit", Statement("yield", lineno+1)
     print((yield) if await foo() else (yield))
+    await trio.lowlevel.checkpoint()


 # Will either enter else, and it's a guaranteed checkpoint - or enter if, in which
 # case the problem is the yield.
 async def foo_ifexp_2():  # error: 0, "exit", Statement("yield", lineno+2)
+    await trio.lowlevel.checkpoint()
     print(
         (yield)  # error: 9, "yield", Statement("function definition", lineno-2)
         if ... and await foo()
         else await foo()
     )
+    await trio.lowlevel.checkpoint()


 # normal function
@@ -585,7 +665,9 @@
     await foo()

     async def foo_func_2():  # error: 4, "exit", Statement("yield", lineno+1)
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Statement("function definition", lineno-1)
+        await trio.lowlevel.checkpoint()


 # autofix doesn't insert newline after nested function def and before checkpoint
@@ -597,6 +679,7 @@

     async def foo_func_4():
         await foo()
+    await trio.lowlevel.checkpoint()


 async def foo_func_5():  # error: 0, "exit", Statement("yield", lineno+2)
@@ -609,12 +692,14 @@
         async def foo_func_7():
             await foo()
             ...
+    await trio.lowlevel.checkpoint()
 # fmt: on


 # No error from function definition, but may shortcut after yield
 async def foo_boolops_1():  # error: 0, "exit", Stmt("yield", line+1)
     _ = await foo() and (yield) and await foo()
+    await trio.lowlevel.checkpoint()


 # loop over non-empty static collection
@@ -641,6 +726,7 @@
         if ...:
             continue
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-7)

     # continue/else
@@ -649,6 +735,7 @@
             continue
         await foo()
     else:
+        await trio.lowlevel.checkpoint()
         yield  # error: 8, "yield", Stmt("yield", line-8)
     await foo()
     yield
@@ -693,6 +780,7 @@

     for _ in ():
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in {1: 2, 3: 4}:
@@ -701,14 +789,17 @@

     for _ in "   ".strip():
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in range(0):
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in (*range(0),):
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in (*(1, 2),):
@@ -717,10 +808,12 @@

     for _ in {**{}}:
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in {**{}, **{}}:
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in {**{1: 2}}:
@@ -746,31 +839,38 @@

     for _ in {}:
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in "":
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in """""":
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in [[], []][0]:
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for _ in [[], []].__getitem__(0):
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # not handled
     for _ in list((1, 2)):
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-5)

     for _ in list():
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # while
@@ -784,6 +884,7 @@
         if ...:
             break
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-6)

     while True:
@@ -796,6 +897,7 @@

     while False:
         await foo()  # type: ignore[unreachable]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     while "hello":
@@ -805,11 +907,13 @@
     # false positive on containers
     while [1, 2]:
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-5)

     # will get caught by any number of linters, but trio911 will also complain
     for _ in 5:  # type: ignore
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-5)

     # range with constant arguments also handled, see more extensive tests in 910
@@ -827,10 +931,12 @@

     for i in range(1 + 1):  # not handled
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for i in range(None):  # type: ignore
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     for i in range(+3):
@@ -839,6 +945,7 @@

     for i in range(-3.5):  # type: ignore
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # duplicated from 910 to have all range tests in one place
@@ -862,20 +969,24 @@

     for i in range(10, 5):
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # binary operations are not handled
     for i in range(3 - 2):
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-5)

     for i in range(10**3):
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # nor nested unary operations
     for i in range(--3):
         await foo()
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-5)

     await foo()
@@ -899,6 +1010,7 @@

     # guaranteed iteration and await in value, but test is not guaranteed
     [await foo() for x in range(10) if bar()]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # guaranteed iteration and await in value
@@ -907,6 +1019,7 @@

     # not guaranteed to iter
     [await foo() for x in bar()]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # await statement in loop expression
@@ -918,10 +1031,12 @@
     yield  # safe

     {await foo() for x in bar()}
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-3)

     # dict comprehensions use same logic as list
     {await foo(): 5 for x in bar()}
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # other than `await` can be in both key&val
@@ -933,9 +1048,11 @@

     # generator expressions are never treated as safe
     (await foo() for x in range(10))
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     (await foo() for x in bar() if await foo())
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-3)

     # async for always safe
@@ -948,27 +1065,33 @@

     # other than in generator expression
     (... async for x in bar())
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-4)

     # multiple loops
     [... for x in range(10) for y in range(10) if await foo()]
     yield
     [... for x in range(10) for y in bar() if await foo()]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-2)
     [... for x in bar() for y in range(10) if await foo()]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-2)

     [await foo() for x in range(10) for y in range(10)]
     yield
     [await foo() for x in range(10) for y in bar()]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-2)
     [await foo() for x in bar() for y in range(10)]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-2)

     # trip loops!
     [... for x in range(10) for y in range(10) async for z in bar()]
     yield
     [... for x in range(10) for y in range(10) for z in range(10)]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-2)

     # multiple ifs
@@ -976,6 +1099,7 @@
     yield

     [... for x in range(10) for y in bar() if await foo() if await foo()]
+    await trio.lowlevel.checkpoint()
     yield  # error: 4, "yield", Stmt("yield", line-3)

     # nested comprehensions
